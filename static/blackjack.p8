pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- blackjack
-- greg bair (greg@gregbair.dev)

function _init()
  game_over=false
  win=false
  player_stands=false
  cls(3)
  make_deck()
  make_player()
  make_dealer()
end

function _update()
  if(not game_over) then
    process_buttons()
    update_player()
    update_dealer()
    if(player_stands) then
      finish_dealer()
      game_over = true
    end
  else
    if(btnp(❎)) _init()
  end
end

function _draw()
    draw_table()
    draw_player()
    draw_dealer() 

  if (game_over) then
    draw_table()
    draw_player()
    draw_dealer()
    end_game()
  else
    draw_info()
  end
end

function end_game()
  if(player.score >21 or (dealer.score <=21 and player.score < dealer.score)) then
    win=false
  else 
    win=true
  end

  if(win) then
    sfx(0)
    print("you win!",4,30,7)
  else
    sfx(1)
    print("you lose!",4,30,7)
  end
  print("your score: "..player.score,4,40,7)
  print("dealer's score: "..dealer.score,4,50,7)
  print("press ❎ to play again!",4,60,7)

end

function draw_table()
  cls(3)
  rectfill(128-13,2,128-2,10,9) -- player score box
  rectfill(128-13,128-10,128-2,128-2,14) -- dealer score box
end 

function draw_info()
  print("❎ to hit, 🅾️ to stand", 4, 30)
  print("dealer stands on 18", 4,40)
end

function process_buttons()
  if (btnp(❎)) then
    sfx(1)
    add(player.hand, draw_card_from_deck())
  end
  if(btnp(🅾️)) then
    player_stands=true
  end
end
-->8
-- deck stuff

function make_deck()
	game_deck = {}
  for s=1,4 do
    for v=1,13 do
      add(game_deck, make_card(v,s))
    end
  end
end

function make_card(value,suit)
	local card={}
	card.value=value
	card.suit=suit
	return card
end

function draw_card_from_deck()
  local i = flr(rnd(#game_deck))
  local card = game_deck[i]
  deli(game_deck, i)
  return card
end

function value_str(val)
  if(val == 1) then
    return "a"
  end

  if(val <= 10) then
    return val
  end

  if(val == 11) then
    return "j"
  end

  if(val == 12) then
    return "q"
  end

  if(val == 13) then
    return "k"
  end

  return "?"
end

function value_int(val)
  if(val <=10) then
    return val
  end
  return 10
end

function draw_card(card,x,y,col)
  rectfill(x+1,y,x+15,y+22,col)
  rectfill(x,y+1,x+16,y+21,col)
  rectfill(x+1,y+2,x+15,y+20,col)
  spr(card.suit,x+4,y+4) -- suit
  print(value_str(card.value),x+6,y+14,7) --value
end

function draw_facedown_card(x,y,col)
  rectfill(x+1,y,x+15,y+22,col)
  rectfill(x,y+1,x+16,y+21,col)
  rectfill(x+2,y+3,x+14,y+19,7)
end
-->8
-- player stuff
function make_player()
  player={}
  player.hand={draw_card_from_deck(), draw_card_from_deck()}
  player.score=0
end

function update_player()
  player.score=0
  for i=1,#player.hand do
    player.score += value_int(player.hand[i].value)
  end
  if(player.score > 21) then
    game_over=true
    win=false
  else
    win=true
  end
end

function draw_player()
  for i=1,#player.hand do
    draw_card(player.hand[i],((i-1)*18)+1,1,9)
  end

  print(player.score,127-10,4,7)
end
-->8
function make_dealer()
  dealer={}
  dealer.hand={draw_card_from_deck(), draw_card_from_deck()}
  dealer.score=0
  dealer.shown_score=0
end

function update_dealer()
  dealer.score=0
  for i=1,#dealer.hand do
    dealer.score += value_int(dealer.hand[i].value)
  end

  dealer.shown_score=0
  for i=2,#dealer.hand do
    dealer.shown_score += value_int(dealer.hand[i].value)
  end
end

function finish_dealer()
  while(dealer.score < 18) do
    add(dealer.hand, draw_card_from_deck())
    update_dealer()
  end
end

function draw_dealer()
  if(not game_over) then
    draw_facedown_card(1,104,14)
    for i=2,#dealer.hand do
      draw_card(dealer.hand[i],((i-1)*18)+1,104,14)
    end
    print(dealer.shown_score,127-10,120,7)
  else
    for i=1,#dealer.hand do
      draw_card(dealer.hand[i],((i-1)*18)+1,104,14)
    end
    print(dealer.score,127-10,120,7)
  end
end

-- dealer stuff
__gfx__
00000000077077000007000000070000000700000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777700077700000777000007770007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777700777770000777000077777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000077777007777777077070770777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000007770000777770077777770777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000700000077700007707700077077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000070000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000777000007770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33999999999999999333999999999999999333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333339999999999993
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333339999999999993
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333339977997779993
39999999799999999939999999799999999933333333333333333333333333333333333333333333333333333333333333333333333333333339997997979993
39999997779999999939999997779999999933333333333333333333333333333333333333333333333333333333333333333333333333333339997997979993
39999977777999999939999977777999999933333333333333333333333333333333333333333333333333333333333333333333333333333339997997979993
39999777777799999939999777777799999933333333333333333333333333333333333333333333333333333333333333333333333333333339977797779993
39999977777999999939999777777799999933333333333333333333333333333333333333333333333333333333333333333333333333333339999999999993
39999997779999999939999977977999999933333333333333333333333333333333333333333333333333333333333333333333333333333339999999999993
39999999799999999939999999799999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999997779999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999997779999999939999997779999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999979999999939999999979999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999779999999939999999979999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999979999999939999999979999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999997779999999939999999979999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
39999999999999999939999999999999999933333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33999999999999999333999999999999999333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333777773333337773377333337373777377733333333337777733333377733773333337737773777377337733333333333333333333333333333333333333
33337737377333333733737333337373373337333333333377333773333337337373333373333733737373737373333333333333333333333333333333333333
33337773777333333733737333337773373337333333333377373773333337337373333377733733777373737373333333333333333333333333333333333333
33337737377333333733737333337373373337333733333377333773333337337373333333733733737373737373333333333333333333333333333333333333
33333777773333333733773333337373777337337333333337777733333337337733333377333733737373737773333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33337733777377737333777377733333377377737773773377333773333337737733333377337773333333333333333333333333333333333333333333333333
33337373733373737333733373733333733337337373737373737333333373737373333337337373333333333333333333333333333333333333333333333333
33337373773377737333773377333333777337337773737373737773333373737373333337337773333333333333333333333333333333333333333333333333
33337373733373737333733373733333337337337373737373733373333373737373333337337373333333333333333333333333333333333333333333333333
33337773777373737773777373733333773337337373737377737733333377337373333377737773333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33eeeeeeeeeeeeeee333eeeeeeeeeeeeeee333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3eeeeeeeeeeeeeeeee3eeeeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3eeeeeeeeeeeeeeeee3eeeeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeeee7eeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeee777eeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeee77777eeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeee7777777eeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeee7777777eeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeee77e77eeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeeee7eeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeee777eeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3ee7777777777777ee3eeeeee777eeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eeeeeeeeeeee3
3ee7777777777777ee3eeeeee7e7eeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eeeeeeeeeeee3
3ee7777777777777ee3eeeeee777eeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333ee77eeeeeeee3
3ee7777777777777ee3eeeeee7e7eeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eee7eeeeeeee3
3ee7777777777777ee3eeeeee7e7eeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eee7eeeeeeee3
3ee7777777777777ee3eeeeeeeeeeeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eee7eeeeeeee3
3eeeeeeeeeeeeeeeee3eeeeeeeeeeeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333ee777eeeeeee3
3eeeeeeeeeeeeeeeee3eeeeeeeeeeeeeeeee3333333333333333333333333333333333333333333333333333333333333333333333333333333eeeeeeeeeeee3
33eeeeeeeeeeeeeee333eeeeeeeeeeeeeee33333333333333333333333333333333333333333333333333333333333333333333333333333333eeeeeeeeeeee3
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333

__sfx__
00020000397503575032750307502d7502c7502a7502775024750207501d7501a75017750117500b7500475000700037000670007700087000a7000c7000e700117001370016700197001d7001f7002270027700
0002000002750027500475004750057500675008750097500b7500d7501075014750197501d750237502d75003600026000260000600000000000000000000000000000000000000000000000000000000000000
